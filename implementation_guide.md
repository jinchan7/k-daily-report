# 日報システム改修実装ガイド

## 修正内容の概要

以下の課題に対する修正を実装しました：

1. **白画面問題の解決**：日報作成・編集、コメント投稿後の白画面問題を解決
2. **通知設定機能の実装**：ユーザーごとに通知設定を変更できる機能を追加
3. **パフォーマンス改善**：キャッシュ戦略の見直しとコード最適化によるパフォーマンス改善
4. **既読数表示機能**：日報の既読状態を記録・表示する機能を追加

## 新規追加ファイル

以下の新規ファイルを追加しました：

1. `read_status.gs` - 既読状態管理機能
2. `comment_utils.gs` - 改良版コメント機能
3. `notification_settings.gs` - 通知設定管理機能
4. `notification_ui.html` - 通知設定UI
5. `detail_integration.md` - detail.htmlへの統合手順（手動対応必要）

## 主な修正内容

### 1. 白画面問題の解決

* コメント送信・返信処理を完全に刷新し、エラーハンドリングを強化
* ローカルストレージを活用した未送信コメントの復元機能
* 通信タイムアウト処理の追加
* 安全なリダイレクト機能の実装

### 2. 通知設定機能

* ユーザーごとの通知設定を管理する機能を追加
* 通知設定を変更するためのUI実装
* 日報投稿時とコメント投稿時の通知処理を改善

### 3. 既読状態管理

* 既読状態を記録するテーブルの作成
* 日報閲覧時に自動的に既読を記録
* 既読数と既読者リストの表示機能

### 4. パフォーマンス改善

* キャッシュ期間を60秒から300秒に延長
* データ取得処理の最適化
* レスポンス時間の短縮

## 導入手順

1. 各新規ファイルをGASプロジェクトに追加
2. `detail_integration.md`の手順に従ってdetail.htmlを修正
3. 既存のファイル(Code.gs)のdoGet関数を修正して既読機能を有効化
4. SHEET_NAMESグローバル変数に'READ_STATUS'を追加

### Code.gs の修正

doGet関数内の以下の部分を修正します：

```javascript
} else if (action === 'detail' && e.parameter.id) {
  // 日報詳細画面
  template = HtmlService.createTemplateFromFile('detail');
  template.report = getReportById(e.parameter.id);
  template.comments = getCommentsByReportId(e.parameter.id);
  
  // 既読状態を記録（閲覧したらすぐに既読とする）
  try {
    recordReadStatus(e.parameter.id, user);
    template.readStatus = getReadStatusByReportId(e.parameter.id);
    template.userNotificationEnabled = getUserNotificationSetting(user);
  } catch (e) {
    Logger.log('既読状態記録エラー: ' + e.toString());
  }
}
```

SHEET_NAMESの変数を修正します：

```javascript
var SHEET_NAMES = {
  DAILY_REPORT: '日報',
  COMMENTS: 'コメント',
  USERS: 'ユーザー',
  SETTINGS: '設定',
  READ_STATUS: '既読状態' // この行を追加
};
```

CACHE_EXPIRATIONを変更します：

```javascript
var CACHE_EXPIRATION = 300; // 300秒に延長
```

### 既読状態テーブルの作成

既読状態を記録するために、スプレッドシートに「既読状態」シートを作成し、以下のヘッダを設定します：

1. ID
2. 日報ID
3. ユーザー
4. 既読日時

## テスト手順

1. 日報の投稿・編集後に白画面になるかどうかを確認
2. コメント投稿・返信後に白画面になるかどうかを確認
3. 通知設定が変更できるかを確認
4. 既読数が表示されるかを確認
5. 他のユーザーがコメントした場合に通知メールが届くかを確認

## トラブルシューティング

以下の点に注意してください：

1. すべての修正ファイルがGASプロジェクトに正しく追加されていることを確認
2. スプレッドシートに「既読状態」シートが正しく作成されていることを確認
3. ブラウザのキャッシュをクリアして再テスト
4. 古いセッションが残っていないか確認
5. GASのログ（View -> Logs）で詳細なエラー情報を確認

## 補足情報

この修正により、システムのパフォーマンスと安定性が大幅に向上しますが、まれに通信エラーが発生する場合があります。その場合は以下の対処を行ってください：

1. ページの再読み込み
2. ブラウザのキャッシュクリア
3. 別のブラウザでの確認

また、システムの動作が重い場合は以下の点を確認してください：

1. スプレッドシートの行数が多くなりすぎていないか
2. 不要なデータを定期的に削除または別シートにアーカイブする
3. CACHE_EXPIRATIONの値を調整する（300〜600秒が推奨）

## 将来の拡張性

今回の修正では以下の機能を追加実装することも検討しましたが、現状の優先度を考慮して見送っています：

1. コメント数のバッジ表示
2. 日報一覧での未読/既読フィルタリング
3. 複数人へのメンション機能
4. コメント編集・削除機能

必要に応じて今後のアップデートで実装することを検討してください。

## まとめ

この改修により、日報システムの主要な問題点が解決されました。特に白画面問題の解消とパフォーマンス向上により、ユーザー体験が大幅に向上します。通知設定と既読機能の追加により、チーム内のコミュニケーションがより円滑になることが期待されます。

---

※実装後に問題が発生した場合は、各ファイルのコメントを参照し、Logger.logの出力を確認してください。
