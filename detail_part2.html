            window.location.href = window.location.href.split('?')[0] + 
                               '?action=detail&id=' + data.reportId;
          } catch (e) {
            console.error('画面更新エラー:', e);
            showMessage('画面更新に失敗しました。手動で更新してください。', 'error');
          }
        } else {
          // 元の内容を復元
          contentElement.value = originalContent;
        }
      }, 5000);
    }, 8000);
    
    // サーバーへ送信
    google.script.run
      .withSuccessHandler(function(result) {
        // タイムアウトをクリア
        clearTimeout(responseTimeout);
        
        console.log('サーバー応答:', result);
        
        // ボタンを元に戻す
        submitButton.textContent = 'コメントを投稿';
        submitButton.disabled = false;
        
        // 成功判定の緩和（successがfalseでなければ成功と見なす）
        if (result && result.success !== false) {
          // 入力欄をクリア
          contentElement.value = '';
          
          // 成功通知
          showMessage('コメントを投稿しました', 'success');
          
          // 3秒後に安全に画面更新
          setTimeout(function() {
            try {
              // 明示的なURLの再構築
              var currentUrl = window.location.href;
              var baseUrl = currentUrl.split('?')[0];
              var newUrl = baseUrl + '?action=detail&id=' + data.reportId;
              
              // ヒストリーAPIを使ってナビゲーション履歴を残す
              window.location.href = newUrl;
            } catch(e) {
              console.error('画面更新エラー:', e);
              showMessage('画面更新に失敗しました。手動で更新してください。', 'error');
            }
          }, 3000);
        } else {
          // エラー表示
          var errorMessage = result && result.message ? 
                         result.message : 
                         '不明なエラーが発生しました';
          showMessage('エラー: ' + errorMessage, 'error');
          
          // どのような場合でも更新を提案
          setTimeout(function() {
            if (confirm('最新情報を確認するためにページを更新しますか？')) {
              try {
                // 更新前にローカルストレージでコメント内容を保持（白画面対策）
                localStorage.setItem('pendingComment', originalContent);
                localStorage.setItem('commentTarget', data.reportId);
                localStorage.setItem('commentTimestamp', new Date().getTime());
                
                window.location.href = window.location.href.split('?')[0] + 
                                   '?action=detail&id=' + data.reportId;
              } catch (e) {
                console.error('画面更新エラー:', e);
                showMessage('画面更新に失敗しました。手動で更新してください。', 'error');
              }
            }
          }, 2000);
        }
      })
      .withFailureHandler(function(error) {
        // タイムアウトをクリア
        clearTimeout(responseTimeout);
        
        console.error('コメント送信エラー:', error);
        
        // ボタンを元に戻す
        submitButton.textContent = 'コメントを投稿';
        submitButton.disabled = false;
        
        // エラー表示
        showMessage('通信エラーが発生しましたが、コメントは保存されている可能性があります', 'error');
        
        // 更新を提案
        setTimeout(function() {
          if (confirm('コメントの保存状態を確認するためにページを更新しますか？')) {
            try {
              // 更新前にローカルストレージでコメント内容を保持（白画面対策）
              localStorage.setItem('pendingComment', originalContent);
              localStorage.setItem('commentTarget', data.reportId);
              localStorage.setItem('commentTimestamp', new Date().getTime());
              
              // リロード
              window.location.href = window.location.href.split('?')[0] + 
                                 '?action=detail&id=' + data.reportId;
            } catch (e) {
              console.error('画面更新エラー:', e);
              showMessage('画面更新に失敗しました。手動で更新してください。', 'error');
            }
          } else {
            // リロードしなかった場合は元の内容を復元
            contentElement.value = originalContent;
          }
        }, 2000);
      })
      .saveComment(data);
    }
