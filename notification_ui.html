<!-- 通知設定UI - 日報詳細画面に含める -->
<div class="card mt-3">
  <div class="card-header">
    通知設定
  </div>
  <div class="card-body">
    <div id="notificationSettingsArea">
      <div class="form-group">
        <label class="form-check">
          <input type="checkbox" id="notificationToggle" class="form-check-input" <?= userNotificationEnabled ? 'checked' : '' ?>>
          <span class="form-check-label">日報やコメントの通知メールを受け取る</span>
        </label>
        <div class="form-text mt-2">
          新しい日報が投稿されたときや、コメントがついたときにメールで通知を受け取ることができます。
        </div>
      </div>
      <div id="notificationStatus" class="alert mt-2" style="display: none;"></div>
    </div>
  </div>
</div>

<script>
// 通知設定の初期化
document.addEventListener('DOMContentLoaded', function() {
  var toggle = document.getElementById('notificationToggle');
  if (toggle) {
    toggle.addEventListener('change', function() {
      updateNotificationSettings(this.checked);
    });
  }
});

// 通知設定の更新
function updateNotificationSettings(enabled) {
  var statusArea = document.getElementById('notificationStatus');
  if (statusArea) {
    statusArea.style.display = 'block';
    statusArea.className = 'alert mt-2 alert-info';
    statusArea.textContent = '設定を更新中...';
  }
  
  google.script.run
    .withSuccessHandler(function(result) {
      console.log('通知設定更新結果:', result);
      
      if (result && result.success) {
        if (statusArea) {
          statusArea.className = 'alert mt-2 alert-success';
          statusArea.textContent = '通知設定を更新しました';
          
          // 3秒後に通知を消す
          setTimeout(function() {
            if (statusArea) {
              statusArea.style.display = 'none';
            }
          }, 3000);
        }
      } else {
        // 失敗時は元の状態に戻す
        var toggle = document.getElementById('notificationToggle');
        if (toggle) {
          toggle.checked = !toggle.checked;
        }
        
        if (statusArea) {
          statusArea.className = 'alert mt-2 alert-danger';
          statusArea.textContent = 'エラー: ' + (result && result.message ? result.message : '設定の更新に失敗しました');
        }
      }
    })
    .withFailureHandler(function(error) {
      console.error('通知設定更新エラー:', error);
      
      // 失敗時は元の状態に戻す
      var toggle = document.getElementById('notificationToggle');
      if (toggle) {
        toggle.checked = !toggle.checked;
      }
      
      if (statusArea) {
        statusArea.className = 'alert mt-2 alert-danger';
        statusArea.textContent = 'エラー: 通信に失敗しました';
      }
    })
    .updateNotificationSettings(enabled);
}
</script>
